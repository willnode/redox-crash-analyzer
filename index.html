<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Redox Crash Analyzer</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/@alexaltea/capstone-js@3.0.5/dist/capstone.min.js"></script>
  <script type="module">
    import * as elfist from 'https://unpkg.com/@wokwi/elfist@1.0.2/dist/esm/index.js';
    window.elfist = elfist;
  </script>
</head>

<body>

  <div id="app">
    <div class="controls">
      <h1>Redox Crash Analyzer</h1>
      <div id="fault-stack-div">
        <div>
          <label for="fault-log">1. Page Fault Message</label>
          <textarea id="fault-log" v-model="faultLog"
            placeholder="Paste kernel log with RIP address here..."></textarea>
        </div>
        <div v-if="callStacks.length > 0" class="call-stack">
          <label for="sysroot-dir">4. Call Stack</label>
          <div class="call-stack-list">
            <div v-for="stack in callStacks">
              <button @click="() => jumpToStack(stack)" :class="{ active: stack == jumpAddress }">{{ stack }}</button>
            </div>
          </div>
        </div>
      </div>
      <div>
        <label for="ld-debug-log">2. LD_DEBUG Output</label>
        <textarea id="ld-debug-log" v-model="ldDebugLog"
          placeholder="Paste 'env LD_DEBUG=all ...' output here..."></textarea>
      </div>
      <div>
        <label for="sysroot-dir">3. Sysroot Directory</label>
        <div class="dir-picker">
          <span>{{ sysrootDirHandle ? sysrootDirHandle.name : 'No directory selected' }}</span>
          <button @click="selectDirectory">Select Sysroot</button>
        </div>
        <small style="opacity: 0.6;">Select the root folder containing the binaries (hint: run make mount).</small>
      </div>
      <button @click="analyzeCrash" :disabled="isLoading || !isReady">
        {{ isLoading ? 'Analyzing...' : 'Analyze Crash' }}
      </button>
      <button @click="generateFullReport" :disabled="isLoading || callStacks.length == 0" style="margin-top: 10px;">
        Full Stack Report
      </button>
    </div>

    <div class="output-view">
      <div class="status">
        <div v-if="error" class="error">{{ error }}</div>
        <div v-else-if="successMessage" class="success">{{ successMessage }}</div>
        <div v-else>Disassembly Output</div>
      </div>

      <div class="jump-controls" v-if="analysisData">
        <div class="jump-input-group">
          <input type="text" v-model="jumpAddress" placeholder="0x..." @keyup.enter="jumpToAddress" />
          <button @click="jumpToAddress">Jump</button>
        </div>
        <div class="symbol-info" v-if="currentSymbolName">{{ currentSymbolName }}</div>
        <div class="symbol-info" v-if="currentSymbolName2">{{ currentSymbolName2 }}</div>
      </div>

      <pre v-html="disassemblyOutput"></pre>
    </div>
  </div>

  <script src="./script.js" type="module"></script>

</body>

</html>